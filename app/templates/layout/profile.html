{% extends 'layout/base.html' %}

{% block content %}
<script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>

<div class="row justify-content-center mt-5 mb-5">
    <div class="col-lg-11">
        <div class="card shadow-lg border-0 rounded-3">
            <div class="card-body p-4 p-md-5">

                {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                {% for category, message in messages %}
                <div class="alert alert-{{ category }} text-center my-3 shadow-sm">{{ message }}</div>
                {% endfor %}
                {% endif %}
                {% endwith %}

                <div class="d-flex justify-content-between align-items-center mb-5 border-bottom pb-3">
                    <h3 class="fw-bold text-primary mb-0"><i class="fas fa-id-card me-2"></i> HỒ SƠ HỌC VIÊN</h3>
                    <span class="badge bg-danger rounded-pill fs-6 px-3 py-2">{{ current_user.type|upper }}</span>
                </div>

                <div class="row">
                    <div class="col-md-5 border-end pe-md-4">
                        <h5 class="fw-bold text-muted mb-4 text-uppercase">I. Thông tin cá nhân</h5>

                        <div class="text-center mb-4">
                            <div class="mb-3">
                                {% if current_user.avatar %}
                                {% if current_user.avatar.startswith('http') %}
                                <img id="avatarPreview" src="{{ current_user.avatar }}" alt="avatar" width="140"
                                     height="140"
                                     class="rounded-circle border border-3 border-primary p-1 shadow"
                                     style="object-fit: cover;">
                                {% else %}
                                <img id="avatarPreview" src="{{ url_for('static', filename=current_user.avatar) }}"
                                     alt="avatar" width="140" height="140"
                                     class="rounded-circle border border-3 border-primary p-1 shadow"
                                     style="object-fit: cover;">
                                {% endif %}
                                {% else %}
                                <i class="fas fa-user-circle fa-7x text-secondary"></i>
                                {% endif %}
                            </div>

                            <h4 class="fw-bold text-dark mb-2">{{ current_user.name }}</h4>

                            <button type="button" id="upload_widget"
                                    class="btn btn-sm btn-outline-primary rounded-pill px-3 shadow-sm">
                                <i class="fas fa-camera me-1"></i> Đổi ảnh đại diện
                            </button>
                        </div>

                        <ul class="list-group list-group-flush mt-3">
                            <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                                <span class="fw-bold text-secondary"><i class="fas fa-user-tag me-2 width-20"></i> Username:</span>
                                <span class="fw-bold text-primary">{{ current_user.username }}</span>
                            </li>

                            {% set gender_map = {1: 'Nam', 2: 'Nữ'} %}
                            <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                                <span class="fw-bold text-secondary"><i class="fas fa-phone-alt me-2 width-20"></i> SĐT:</span>
                                <span class="fw-bold text-dark">{{ current_user.phone_number }}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                                <span class="fw-bold text-secondary"><i class="fas fa-envelope me-2 width-20"></i> Email:</span>
                                <span class="fw-bold text-dark">{{ current_user.email }}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                                <span class="fw-bold text-secondary"><i class="fas fa-venus-mars me-2 width-20"></i> Giới tính:</span>
                                <span>{{ gender_map[current_user.gender] if current_user.gender is not none else 'N/A' }}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                                <span class="fw-bold text-secondary"><i class="fas fa-birthday-cake me-2 width-20"></i> Ngày sinh:</span>
                                <span>{{ current_user.dob.strftime('%d/%m/%Y') }}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                                <span class="fw-bold text-secondary"><i class="fas fa-map-marker-alt me-2 width-20"></i> Địa chỉ:</span>
                                <span class="text-end text-break"
                                      style="max-width: 200px;">{{ current_user.address }}</span>
                            </li>
                        </ul>
                    </div>

                    <div class="col-md-7 ps-md-4 mt-4 mt-md-0">
                        <h5 class="fw-bold text-muted mb-4 text-uppercase">II. Khóa học của tôi</h5>

                        {% if enrollment_info %}
                        <div class="vstack gap-3">
                            {% for item in enrollment_info %}
                            <div class="card border-0 shadow-sm bg-light overflow-hidden">
                                <div class="row g-0">
                                    <div class="col-sm-3 d-none d-sm-block position-relative">
                                        {% if item.course_image %}
                                        <img src="{{ item.course_image }}" class="img-fluid h-100 w-100"
                                             style="object-fit: cover;" alt="Course Img">
                                        {% else %}
                                        <div class="bg-secondary h-100 w-100 d-flex align-items-center justify-content-center text-white">
                                            <i class="fas fa-book fa-2x"></i>
                                        </div>
                                        {% endif %}
                                    </div>

                                    <div class="col-sm-9">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div>
                                                    <h6 class="card-title fw-bold text-primary mb-1">
                                                        {{ item.course_name }}
                                                        <span class="badge bg-white text-secondary border ms-1 fw-normal"
                                                              style="font-size: 0.75rem;">
                                                                #{{ item.course_id }}
                                                            </span>
                                                    </h6>

                                                    <div class="d-flex flex-column gap-1 mt-2">
                                                        <small class="text-dark fw-bold">
                                                            <i class="fas fa-chalkboard-teacher me-2 text-secondary width-20"></i>
                                                            Lớp: <span class="text-primary">{{ item.class_name }}</span>
                                                        </small>
                                                        <small class="text-dark">
                                                            <i class="fas fa-user-tie me-2 text-secondary width-20"></i>
                                                            GV: <span class="fw-bold">{{ item.teacher_name if item.teacher_name else 'Chưa phân công' }}</span>
                                                        </small>
                                                    </div>
                                                </div>

                                                {% if item.bill_status.name == 'UNPAID' %}
                                                <span class="badge bg-warning text-dark"><i
                                                        class="fas fa-hourglass-half me-1"></i> Chờ thanh toán</span>
                                                {% elif item.bill_status.name == 'PAID' or item.enrollment_status.name
                                                == 'APPROVED' %}
                                                <span class="badge bg-success"><i class="fas fa-check-circle me-1"></i> Đã kích hoạt</span>
                                                {% else %}
                                                <span class="badge bg-secondary">{{ item.enrollment_status.name }}</span>
                                                {% endif %}
                                            </div>

                                            <div class="mt-3 d-flex justify-content-between align-items-end border-top pt-2">
                                                <div class="small text-muted">
                                                    <div class="mb-1"><i class="far fa-calendar-alt me-2 width-20"></i>
                                                        Khai giảng: <strong>{{ item.start_date.strftime('%d/%m/%Y')
                                                            }}</strong></div>
                                                    <div><i class="fas fa-tag me-2 width-20"></i> Học phí: {{
                                                        "{:,.0f}".format(item.fee) }} đ
                                                    </div>
                                                </div>

                                                {% if item.bill_status.name == 'UNPAID' %}
                                                <div class="d-flex gap-2">
                                                    <a href="{{ url_for('checkout', class_id=item.class_id) }}"
                                                       class="btn btn-sm btn-danger fw-bold shadow-sm">
                                                        <i class="fas fa-wallet me-1"></i> Thanh toán
                                                    </a>

                                                    <form action="{{ url_for('cancel_enrollment', enrollment_id=item.enrollment_id) }}"
                                                          method="POST"
                                                          onsubmit="return confirm('Bạn có chắc chắn muốn hủy đăng ký khóa học này không?');">
                                                        <button type="submit"
                                                                class="btn btn-sm btn-outline-secondary fw-bold shadow-sm">
                                                            <i class="fas fa-trash-alt me-1"></i> Hủy
                                                        </button>
                                                    </form>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-5 border rounded-3 bg-white">
                            <img src="https://cdn-icons-png.flaticon.com/512/7486/7486744.png" width="100"
                                 class="mb-3 opacity-50">
                            <p class="text-muted fw-bold">Bạn chưa đăng ký khóa học nào.</p>
                            <a href="{{ url_for('index') }}" class="btn btn-primary rounded-pill px-4">
                                <i class="fas fa-search me-2"></i> Tìm khóa học ngay
                            </a>
                        </div>
                        {% endif %}

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<form id="avatarUpdateForm" method="POST" action="{{ url_for('update_avatar') }}" style="display: none;">
    <input type="hidden" name="new_avatar" id="newAvatarInput">
</form>

<style>
    .width-20 { width: 25px; text-align: center; display: inline-block; }
</style>
{% endblock %}